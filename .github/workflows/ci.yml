name: CI

on:
  push:
    branches:
      - name
    paths-ignore:
      - "**.md"
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
    paths-ignore:
      - "**.md"
  merge_group:

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: read

    outputs:
      all: ${{ steps.filter.outputs.all }}
      packaging: ${{ steps.filter.outputs.packaging }}
      configcat: ${{ steps.filter.outputs.configcat }}
      envvar: ${{ steps.filter.outputs.envvar }}
      featuremanagement: ${{ steps.filter.outputs.featuremanagement }}
      flagd_unit: ${{ steps.filter.outputs.flagd_unit }}
      flagd_e2e: ${{ steps.filter.outputs.flagd_e2e }}
      flagsmith: ${{ steps.filter.outputs.flagsmith }}
      flipt: ${{ steps.filter.outputs.flipt }}
      statsig: ${{ steps.filter.outputs.statsig }}
      gofeatureflag: ${{ steps.filter.outputs.gofeatureflag }}
      ofrep: ${{ steps.filter.outputs.ofrep }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            all:
              - '.github/workflows/**'
              - 'global.json'
              - 'nuget.config'
              - 'build/**'
              - 'src/Directory.Build.props'
              - 'src/Directory.Build.targets'
              - 'test/Directory.Build.props'
              - 'DotnetSdkContrib.slnx'
              - 'src/**/Directory.Build.props'
              - 'src/**/Directory.Build.targets'
              - 'test/**/Directory.Build.props'

            packaging:
              - 'src/**'
              - '.github/workflows/**'
              - 'global.json'
              - 'nuget.config'
              - 'build/**'

            configcat:
              - 'src/OpenFeature.Contrib.Providers.ConfigCat/**'
              - 'test/OpenFeature.Contrib.Providers.ConfigCat.Test/**'

            envvar:
              - 'src/OpenFeature.Contrib.Providers.EnvVar/**'
              - 'test/OpenFeature.Contrib.Providers.EnvVar.Test/**'

            featuremanagement:
              - 'src/OpenFeature.Contrib.Providers.FeatureManagement/**'
              - 'test/OpenFeature.Contrib.Providers.FeatureManagement.Test/**'

            flagd_unit:
              - 'src/OpenFeature.Contrib.Providers.Flagd/**'
              - 'test/OpenFeature.Contrib.Providers.Flagd.Test/**'

            flagd_e2e:
              - 'src/OpenFeature.Contrib.Providers.Flagd/**'
              - 'test/OpenFeature.Contrib.Providers.Flagd.E2e.Common/**'
              - 'test/OpenFeature.Contrib.Providers.Flagd.E2e.ProcessTest/**'
              - 'test/OpenFeature.Contrib.Providers.Flagd.E2e.RpcTest/**'
              - 'test/OpenFeature.Contrib.Providers.Flagd.E2e.Test/**'
              - 'samples/Flagd/**'

            flagsmith:
              - 'src/OpenFeature.Contrib.Providers.Flagsmith/**'
              - 'test/OpenFeature.Contrib.Providers.Flagsmith.Test/**'

            flipt:
              - 'src/OpenFeature.Contrib.Providers.Flipt/**'
              - 'test/OpenFeature.Contrib.Providers.Flipt.Test/**'

            statsig:
              - 'src/OpenFeature.Contrib.Providers.Statsig/**'
              - 'test/OpenFeature.Contrib.Providers.Statsig.Test/**'

            gofeatureflag:
              - 'src/OpenFeature.Providers.GOFeatureFlag/**'
              - 'test/OpenFeature.Providers.GOFeatureFlag.Test/**'

            ofrep:
              - 'src/OpenFeature.Providers.Ofrep/**'
              - 'test/OpenFeature.Providers.Ofrep.Test/**'

  build:
    needs: changes
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: ConfigCat
            filterKey: configcat
            testProject: test/OpenFeature.Contrib.Providers.ConfigCat.Test/OpenFeature.Contrib.Providers.ConfigCat.Test.csproj
          - os: windows-latest
            name: ConfigCat
            filterKey: configcat
            testProject: test/OpenFeature.Contrib.Providers.ConfigCat.Test/OpenFeature.Contrib.Providers.ConfigCat.Test.csproj

          - os: ubuntu-latest
            name: EnvVar
            filterKey: envvar
            testProject: test/OpenFeature.Contrib.Providers.EnvVar.Test/OpenFeature.Contrib.Providers.EnvVar.Test.csproj
          - os: windows-latest
            name: EnvVar
            filterKey: envvar
            testProject: test/OpenFeature.Contrib.Providers.EnvVar.Test/OpenFeature.Contrib.Providers.EnvVar.Test.csproj

          - os: ubuntu-latest
            name: FeatureManagement
            filterKey: featuremanagement
            testProject: test/OpenFeature.Contrib.Providers.FeatureManagement.Test/OpenFeature.Contrib.Providers.FeatureManagement.Test.csproj
          - os: windows-latest
            name: FeatureManagement
            filterKey: featuremanagement
            testProject: test/OpenFeature.Contrib.Providers.FeatureManagement.Test/OpenFeature.Contrib.Providers.FeatureManagement.Test.csproj

          - os: ubuntu-latest
            name: Flagd (unit)
            filterKey: flagd_unit
            testProject: test/OpenFeature.Contrib.Providers.Flagd.Test/OpenFeature.Contrib.Providers.Flagd.Test.csproj
          - os: windows-latest
            name: Flagd (unit)
            filterKey: flagd_unit
            testProject: test/OpenFeature.Contrib.Providers.Flagd.Test/OpenFeature.Contrib.Providers.Flagd.Test.csproj

          - os: ubuntu-latest
            name: Flagsmith
            filterKey: flagsmith
            testProject: test/OpenFeature.Contrib.Providers.Flagsmith.Test/OpenFeature.Contrib.Providers.Flagsmith.Test.csproj
          - os: windows-latest
            name: Flagsmith
            filterKey: flagsmith
            testProject: test/OpenFeature.Contrib.Providers.Flagsmith.Test/OpenFeature.Contrib.Providers.Flagsmith.Test.csproj

          - os: ubuntu-latest
            name: Flipt
            filterKey: flipt
            testProject: test/OpenFeature.Contrib.Providers.Flipt.Test/OpenFeature.Contrib.Providers.Flipt.Test.csproj
          - os: windows-latest
            name: Flipt
            filterKey: flipt
            testProject: test/OpenFeature.Contrib.Providers.Flipt.Test/OpenFeature.Contrib.Providers.Flipt.Test.csproj

          - os: ubuntu-latest
            name: Statsig
            filterKey: statsig
            testProject: test/OpenFeature.Contrib.Providers.Statsig.Test/OpenFeature.Contrib.Providers.Statsig.Test.csproj
          - os: windows-latest
            name: Statsig
            filterKey: statsig
            testProject: test/OpenFeature.Contrib.Providers.Statsig.Test/OpenFeature.Contrib.Providers.Statsig.Test.csproj

          - os: ubuntu-latest
            name: GOFeatureFlag
            filterKey: gofeatureflag
            testProject: test/OpenFeature.Providers.GOFeatureFlag.Test/OpenFeature.Providers.GOFeatureFlag.Test.csproj
          - os: windows-latest
            name: GOFeatureFlag
            filterKey: gofeatureflag
            testProject: test/OpenFeature.Providers.GOFeatureFlag.Test/OpenFeature.Providers.GOFeatureFlag.Test.csproj

          - os: ubuntu-latest
            name: OFREP
            filterKey: ofrep
            testProject: test/OpenFeature.Providers.Ofrep.Test/OpenFeature.Providers.Ofrep.Test.csproj
          - os: windows-latest
            name: OFREP
            filterKey: ofrep
            testProject: test/OpenFeature.Providers.Ofrep.Test/OpenFeature.Providers.Ofrep.Test.csproj

    name: Build & Test (${{ matrix.name }} â€¢ ${{ matrix.os }})

    if: needs.changes.outputs.all == 'true' || needs.changes.outputs[matrix.filterKey] == 'true'

    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          global-json-file: global.json
          source-url: https://nuget.pkg.github.com/open-feature/index.json

      - name: Cache NuGet packages
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore ${{ matrix.testProject }}

      - name: Test
        run: dotnet test ${{ matrix.testProject }} --no-restore --logger GitHubActions

  e2e:
    needs: changes
    if: needs.changes.outputs.all == 'true' || needs.changes.outputs.flagd_e2e == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          global-json-file: global.json
          source-url: https://nuget.pkg.github.com/open-feature/index.json

      - name: Test
        run: dotnet build && E2E=true dotnet test --logger GitHubActions

  packaging:
    needs: [changes, build]
    if: needs.changes.outputs.packaging == 'true'

    permissions:
      contents: read
      packages: write

    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          global-json-file: global.json
          source-url: https://nuget.pkg.github.com/open-feature/index.json

      - name: Cache NuGet packages
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Pack NuGet packages (CI versions)
        if: startsWith(github.ref, 'refs/heads/')
        run: dotnet pack --no-restore --version-suffix "ci.$(date -u +%Y%m%dT%H%M%S)+sha.${GITHUB_SHA:0:9}"

      - name: Pack NuGet packages (PR versions)
        if: startsWith(github.ref, 'refs/pull/')
        run: dotnet pack --no-restore --version-suffix "pr.$(date -u +%Y%m%dT%H%M%S)+sha.${GITHUB_SHA:0:9}"

      - name: Publish NuGet packages (base)
        if: github.event.pull_request.head.repo.fork == false
        run: dotnet nuget push "src/**/*.nupkg" --api-key "${{ secrets.GITHUB_TOKEN }}" --source https://nuget.pkg.github.com/open-feature/index.json --skip-duplicate

      - name: Publish NuGet packages (fork)
        if: github.event.pull_request.head.repo.fork == true
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: nupkgs
          path: src/**/*.nupkg
